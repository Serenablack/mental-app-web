<div class="mood-entry-container">
  <div class="form-header">
    <h1 class="form-title">
      <mat-icon class="form-icon">mood</mat-icon>
      How are you feeling today?
    </h1>
    <p class="form-subtitle">Take a moment to check in with yourself</p>
  </div>

  <form [formGroup]="moodForm" (ngSubmit)="onSubmit()" class="mood-form">
    <mat-card class="form-card">
      <mat-card-content>
        <!-- Emotions Selection -->
        <div class="form-section">
          <h3 class="section-title">
            <mat-icon class="section-icon">psychology</mat-icon>
            What emotions are you experiencing?
          </h3>
          <p class="section-hint">
            First select a primary emotion, then choose a specific feeling
          </p>

          <!-- Primary Emotions Selection -->
          <div
            class="emotion-selection-container"
            *ngIf="!selectedPrimaryEmotion"
          >
            <h4 class="emotion-category-title">Choose a primary emotion:</h4>
            <div class="emotion-grid">
              <button
                *ngFor="let emotion of primaryEmotions"
                type="button"
                class="emotion-card"
                [class.has-selected-children]="
                  hasSelectedSubEmotions(emotion.id)
                "
                (click)="onPrimaryEmotionChange(emotion)"
              >
                <span class="emotion-label">{{ emotion.label }}</span>
              </button>
            </div>
          </div>

          <!-- Sub-Emotions Selection -->
          <div
            class="emotion-selection-container"
            *ngIf="selectedPrimaryEmotion"
          >
            <div class="emotion-breadcrumb">
              <button
                type="button"
                class="back-button"
                (click)="goBackToPrimaryEmotions()"
              >
                <mat-icon>arrow_back</mat-icon>
                Back to primary emotions
              </button>
              <span class="selected-primary">
                Selected: <strong>{{ selectedPrimaryEmotion.label }}</strong>
              </span>
            </div>

            <h4 class="emotion-category-title">
              Choose a specific
              {{ selectedPrimaryEmotion.label.toLowerCase() }} feeling:
            </h4>
            <div class="emotion-grid">
              <button
                *ngFor="let emotion of subEmotions"
                type="button"
                class="emotion-card sub-emotion"
                [class.selected]="isEmotionSelected(emotion.id)"
                (click)="onSubEmotionChange(emotion)"
              >
                <span class="emotion-label">{{ emotion.label }}</span>
              </button>
            </div>
          </div>

          <!-- Selected Emotions Display -->
          <div
            class="selected-emotions-display"
            *ngIf="getSelectedEmotionLabels().length > 0"
          >
            <h4 class="selected-title">
              <mat-icon class="title-icon">check_circle</mat-icon>
              Selected Emotions ({{ getSelectedEmotionsWithDetails().length }})
            </h4>
            <div class="selected-emotions-list">
              <div
                *ngFor="let emotion of getSelectedEmotionsWithDetails()"
                class="selected-emotion-chip"
              >
                <div class="emotion-chip-content">
                  <span class="emotion-chip-label">{{ emotion.label }}</span>
                  <span
                    class="emotion-chip-category"
                    *ngIf="emotion.primaryLabel"
                  >
                    {{ emotion.primaryLabel }}
                  </span>
                </div>
                <button
                  type="button"
                  class="remove-emotion-btn"
                  (click)="removeSelectedEmotion(emotion.id)"
                  [attr.aria-label]="'Remove ' + emotion.label"
                  [attr.title]="'Remove ' + emotion.label"
                >
                  <mat-icon>close</mat-icon>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Energy Level -->
        <div class="form-section">
          <h3 class="section-title">
            <mat-icon class="section-icon">energy_savings</mat-icon>
            How much energy do you have right now?
          </h3>
          <p class="section-hint">
            Rate your current energy level from 1 (very low) to 5 (very high)
          </p>

          <div class="energy-slider">
            <mat-slider
              min="1"
              max="5"
              step="1"
              discrete
              showTickMarks
              class="energy-slider-control"
            >
              <input matSliderThumb formControlName="energyLevel" />
            </mat-slider>
            <div class="energy-labels">
              <span class="energy-label">1 - Very Low</span>
              <span class="energy-label">2 - Low</span>
              <span class="energy-label">3 - Moderate</span>
              <span class="energy-label">4 - High</span>
              <span class="energy-label">5 - Very High</span>
            </div>
            <div class="energy-value">
              <div class="energy-description">
                {{
                  getEnergyDescription(moodForm.get("energyLevel")?.value || 3)
                }}
              </div>
            </div>
          </div>
        </div>

        <!-- Environment -->
        <div class="form-section">
          <h3 class="section-title">
            <mat-icon class="section-icon">group</mat-icon>
            What's your comfort environment?
          </h3>

          <mat-radio-group
            formControlName="comfortEnvironment"
            class="environment-options"
          >
            <mat-radio-button value="ALONE" class="environment-option">
              <mat-icon class="option-icon">person</mat-icon>
              Alone - I prefer to be by myself right now
            </mat-radio-button>
            <mat-radio-button value="IN_GROUP" class="environment-option">
              <mat-icon class="option-icon">group</mat-icon>
              In a group - I'd like to be around others
            </mat-radio-button>
          </mat-radio-group>
        </div>

        <!-- Location -->
        <div class="form-section">
          <h3 class="section-title">
            <mat-icon class="section-icon">location_on</mat-icon>
            Where are you right now? (Optional)
          </h3>

          <mat-form-field class="full-width">
            <mat-label>Location</mat-label>
            <input
              matInput
              formControlName="location"
              placeholder="e.g., Home, Office, Park, Coffee Shop"
              maxlength="100"
            />
            <mat-hint>This helps us understand your context</mat-hint>
          </mat-form-field>
        </div>

        <!-- Description -->
        <div class="form-section">
          <h3 class="section-title">
            <mat-icon class="section-icon">edit</mat-icon>
            What's on your mind? (Optional)
          </h3>
          <p class="section-hint">
            Share what might have caused these feelings
          </p>

          <mat-form-field class="full-width">
            <mat-label>Description</mat-label>
            <textarea
              matInput
              formControlName="description"
              placeholder="Describe what's happening or what you're thinking about..."
              rows="4"
              maxlength="5000"
            >
            </textarea>
            <mat-hint
              >{{ moodForm.get("description")?.value?.length || 0 }}/5000
              characters</mat-hint
            >
          </mat-form-field>

          <!-- Voice Input Button -->
          <div class="voice-input-actions">
            <button
              type="button"
              mat-stroked-button
              color="accent"
              class="voice-input-btn"
              [class.recording]="isRecording"
              (click)="
                isRecording ? stopVoiceRecording() : startVoiceRecording()
              "
            >
              <mat-icon>{{ isRecording ? "mic" : "mic_none" }}</mat-icon>
              {{ isRecording ? "Stop Voice Input" : "Use Voice Input" }}
            </button>
            <span class="voice-hint" *ngIf="isRecording">
              <mat-icon class="recording-indicator"
                >fiber_manual_record</mat-icon
              >
              Recording... Speak now
            </span>
          </div>
        </div>
      </mat-card-content>

      <mat-card-actions class="form-actions">
        <button
          type="button"
          mat-stroked-button
          class="cancel-btn"
          (click)="onCancel()"
        >
          <mat-icon>cancel</mat-icon>
          Cancel
        </button>

        <button
          type="submit"
          mat-raised-button
          color="primary"
          class="submit-btn"
          [disabled]="!moodForm.valid || isSubmitting"
        >
          <mat-icon *ngIf="!isSubmitting">save</mat-icon>
          <mat-spinner *ngIf="isSubmitting" diameter="20"></mat-spinner>
          {{ isSubmitting ? "Saving..." : "Save Mood Entry" }}
        </button>
      </mat-card-actions>
    </mat-card>
  </form>

  <!-- Progress Indicator -->
  <div class="progress-overlay" *ngIf="isSubmitting">
    <mat-card class="progress-card">
      <mat-card-content>
        <mat-progress-spinner
          mode="indeterminate"
          diameter="60"
          color="primary"
        >
        </mat-progress-spinner>
        <h3>Saving your mood entry...</h3>
        <p>
          We're processing your entry and generating personalized activity
          suggestions
        </p>
      </mat-card-content>
    </mat-card>
  </div>
</div>
